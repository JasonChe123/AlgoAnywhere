{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Running Backtest - Equity Long/Short Strategy{% endblock %}

{% block extra_css %}
<style>
.container {
    padding-left: 2rem;
    padding-right: 2rem;
    max-width: 1600px;
    width: 100%;
}

@media (max-width: 768px) {
    .container {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}

@media (min-width: 1400px) {
    .container {
        padding-left: 3rem;
        padding-right: 3rem;
    }
}

.page-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 2rem;
    margin: -1rem -2rem 2rem -2rem;
    border-radius: 0 0 1rem 1rem;
}

@media (max-width: 768px) {
    .page-header {
        margin: -1rem -1rem 2rem -1rem;
        padding: 1.5rem;
    }
}

.page-header h1 {
    font-weight: 700;
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.card {
    border-radius: 1rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    margin-bottom: 1.5rem;
    border: none;
    margin-left: 0;
    margin-right: 0;
}

.card-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-bottom: 2px solid #e2e8f0;
    border-radius: 1rem 1rem 0 0 !important;
    padding: 1.5rem;
}

.card-header h3 {
    color: var(--primary-color);
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
}

.card-header i {
    color: var(--secondary-color);
    margin-right: 0.5rem;
}

.card-body {
    padding: 2rem;
}

.btn-lg {
    padding: 0.875rem 2rem;
    font-size: 1rem;
    border-radius: 0.75rem;
    margin: 0.5rem;
}

.action-section {
    margin-top: 3rem;
    padding: 2rem;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 1rem;
    margin-left: 0;
    margin-right: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-chart-line"></i> Running Backtest</h1>
            <a href="{% url 'strategies:equity_long_short_home' %}" class="btn btn-light">
                <i class="fas fa-arrow-left"></i> Back to Strategy
            </a>
        </div>
    </div>

    <!-- Configuration Summary -->
    <div class="card mb-4">
        <div class="card-header">
            <h3><i class="fas fa-cog"></i> Backtest Configuration</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>Basic Settings</h5>
                    <ul class="list-unstyled">
                        <li><strong>Name:</strong> {{ config.name }}</li>
                        <li><strong>Initial Capital:</strong> ${{ config.initial_capital|floatformat:0|intcomma }}</li>
                        <li><strong>Period:</strong> {{ config.start_date }} to {{ config.end_date }}</li>
                        <li><strong>Total Holdings:</strong> {{ config.total_stocks_holding }} stocks</li>
                        <li><strong>Ranking Metric:</strong> {{ config.ranking_metric|title }}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>Filtering Criteria</h5>
                    <ul class="list-unstyled">
                        <li><strong>Sectors:</strong> {{ config.sectors|length }} selected</li>
                        <li><strong>Market Cap:</strong> ${{ config.min_market_cap|floatformat:0|intcomma }} - ${{ config.max_market_cap|floatformat:0|intcomma }}</li>
                        <li><strong>Stock Price:</strong> ${{ config.min_stock_price }} - ${{ config.max_stock_price }}</li>
                        <li><strong>Volume:</strong> {{ config.min_volume|intcomma }} - {{ config.max_volume|intcomma }} shares</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Backtest Progress -->
    <div class="card mb-4">
        <div class="card-header">
            <h3><i class="fas fa-chart-line"></i> Backtest Progress</h3>
        </div>
        <div class="card-body">
            <div id="progressContainer">
                <div class="text-center mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2">Initializing backtest...</p>
                </div>
                
                <div class="progress mb-3" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="progressBar">0%</div>
                </div>
                
                <div id="statusMessages" class="alert alert-info">
                    <strong>Status:</strong> <span id="statusText">Preparing data...</span>
                </div>
                
                <div id="errorMessages" class="alert alert-danger" style="display: none;">
                    <strong>Error:</strong> <span id="errorText"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy Details -->
    <div class="card mb-4">
        <div class="card-header">
            <h3><i class="fas fa-info-circle"></i> Strategy Execution Details</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-12">
                    <h5>Monthly Rebalancing Process</h5>
                    <ol>
                        <li><strong>Filter Universe:</strong> Apply your filtering criteria to select eligible stocks</li>
                        <li><strong>Calculate Metrics:</strong> Compute {{ config.ranking_metric|title }} for all eligible stocks</li>
                        <li><strong>Rank Stocks:</strong> Sort stocks by the selected metric (highest to lowest)</li>
                        <li><strong>Select Positions:</strong> 
                            <ul>
                                <li>Go long on top {% widthratio config.total_stocks_holding 2 1 %} stocks</li>
                                <li>Go short on bottom {% widthratio config.total_stocks_holding 2 1 %} stocks</li>
                            </ul>
                        </li>
                        <li><strong>Equal Weighting:</strong> Allocate equal capital to each position</li>
                        <li><strong>Monthly Rebalancing:</strong> Repeat process on first trading day of each month</li>
                    </ol>
                    
                    <h5 class="mt-3">Performance Metrics</h5>
                    <p>The backtest will calculate and compare the following metrics:</p>
                    <ul>
                        <li>Total Return and Annualized Return</li>
                        <li>Sharpe Ratio and Sortino Ratio</li>
                        <li>Maximum Drawdown</li>
                        <li>Volatility and Beta</li>
                        <li>Win Rate and Average Trade Return</li>
                        <li>Performance vs S&P 500 Benchmark</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-section">
        <div class="row">
            <div class="col-12 text-center">
                <button type="button" class="btn btn-primary btn-lg" id="startBacktestBtn">
                    <i class="fas fa-play"></i> Start Backtest
                </button>
                <button type="button" class="btn btn-warning btn-lg" id="pauseBacktestBtn" style="display: none;">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button type="button" class="btn btn-danger btn-lg" id="cancelBacktestBtn" style="display: none;">
                    <i class="fas fa-stop"></i> Cancel
                </button>
                <a href="{% url 'strategies:equity_long_short_backtest_config' %}" class="btn btn-secondary btn-lg ms-3">
                    <i class="fas fa-arrow-left"></i> Modify Configuration
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let backtestInterval;
    let isPaused = false;
    
    function updateProgress(percentage, status) {
        $('#progressBar').css('width', percentage + '%').text(percentage + '%');
        $('#statusText').text(status);
        $('.progress').show();
    }
    
    function showError(message) {
        $('#errorText').text(message);
        $('#errorMessages').show();
        $('#statusMessages').hide();
        $('.spinner-border').hide();
        clearInterval(backtestInterval);
        $('#startBacktestBtn').show();
        $('#pauseBacktestBtn').hide();
        $('#cancelBacktestBtn').hide();
    }
    
    function startBacktest() {
        $('#startBacktestBtn').hide();
        $('#pauseBacktestBtn').show();
        $('#cancelBacktestBtn').show();
        $('.spinner-border').show();
        $('#statusMessages').show();
        $('#errorMessages').hide();
        
        // Simulate backtest progress
        let progress = 0;
        backtestInterval = setInterval(function() {
            if (!isPaused && progress < 100) {
                progress += Math.random() * 5;
                if (progress > 100) progress = 100;
                
                let status = '';
                if (progress < 20) {
                    status = 'Loading stock data...';
                } else if (progress < 40) {
                    status = 'Filtering universe based on criteria...';
                } else if (progress < 60) {
                    status = 'Calculating fundamental metrics...';
                } else if (progress < 80) {
                    status = 'Running monthly rebalancing simulations...';
                } else if (progress < 95) {
                    status = 'Calculating performance metrics...';
                } else {
                    status = 'Finalizing results...';
                }
                
                updateProgress(Math.round(progress), status);
                
                if (progress >= 100) {
                    clearInterval(backtestInterval);
                    $('.spinner-border').hide();
                    $('#pauseBacktestBtn').hide();
                    $('#cancelBacktestBtn').hide();
                    
                    // Redirect to results
                    setTimeout(function() {
                        window.location.href = '{% url "strategies:equity_long_short_run_backtest" %}';
                    }, 1000);
                }
            }
        }, 500);
        
        // Actually start the backtest via AJAX
        $.ajax({
            url: '{% url "strategies:equity_long_short_run_backtest" %}',
            method: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    // Store results and redirect
                    window.location.href = '{% url "strategies:equity_long_short_backtest_results" %}';
                } else {
                    showError(response.error || 'An error occurred during backtest');
                }
            },
            error: function(xhr, status, error) {
                showError('Network error: ' + error);
            }
        });
    }
    
    $('#startBacktestBtn').click(function() {
        startBacktest();
    });
    
    $('#pauseBacktestBtn').click(function() {
        isPaused = !isPaused;
        if (isPaused) {
            $(this).html('<i class="fas fa-play"></i> Resume');
            $('#statusText').text('Paused');
        } else {
            $(this).html('<i class="fas fa-pause"></i> Pause');
        }
    });
    
    $('#cancelBacktestBtn').click(function() {
        if (confirm('Are you sure you want to cancel the backtest?')) {
            clearInterval(backtestInterval);
            window.location.href = '{% url "strategies:equity_long_short_backtest_config" %}';
        }
    });
    
    // Auto-start backtest when page loads
    setTimeout(function() {
        startBacktest();
    }, 1000);
});
</script>
{% endblock %}
