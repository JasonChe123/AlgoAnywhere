{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load math_filters %}

{% block title %}Running Backtest - Equity Long/Short Strategy{% endblock %}

{% block extra_css %}
<style>
.container {
    padding-left: 2rem;
    padding-right: 2rem;
    max-width: 1600px;
    width: 100%;
}

@media (max-width: 768px) {
    .container {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}

@media (min-width: 1400px) {
    .container {
        padding-left: 3rem;
        padding-right: 3rem;
    }
}

.page-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 2rem;
    margin: -1rem -2rem 2rem -2rem;
    border-radius: 0 0 1rem 1rem;
}

@media (max-width: 768px) {
    .page-header {
        margin: -1rem -1rem 2rem -1rem;
        padding: 1.5rem;
    }
}

.page-header h1 {
    font-weight: 700;
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.card {
    border-radius: 1rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    margin-bottom: 1.5rem;
    border: 1px solid var(--border);
    margin-left: 0;
    margin-right: 0;
}

.card-header {
    background: var(--bg-elevated);
    border-bottom: 2px solid var(--border);
    border-radius: 1rem 1rem 0 0 !important;
    padding: 1.5rem;
}

.card-header h3 {
    color: var(--text);
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
}

.card-header i {
    color: var(--accent);
    margin-right: 0.5rem;
}

.card-body {
    padding: 2rem;
    background: var(--bg-card);
}

.btn-lg {
    padding: 0.875rem 2rem;
    font-size: 1rem;
    border-radius: 0.75rem;
    margin: 0.5rem;
}

.action-section {
    margin-top: 3rem;
    padding: 2rem;
    background: transparent;
    border-radius: 1rem;
    margin-left: 0;
    margin-right: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-chart-line"></i> Running Backtest</h1>
            <a href="{% url 'strategies:equity_long_short_home' %}" class="btn btn-light">
                <i class="fas fa-arrow-left"></i> Back to Strategy
            </a>
        </div>
    </div>

    <!-- Configuration Summary -->
    <div class="card mb-4">
        <div class="card-header">
            <h3><i class="fas fa-cog"></i> Backtest Configuration</h3>
        </div>
        <div class="card-body">
            <div class="config-list">
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">Name:</div>
                    <div>{{ config.name }}</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">Period:</div>
                    <div>{{ config.start_date }} to {{ config.end_date }}</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">Total Holdings:</div>
                    <div>{{ config.total_stocks_holding|add:config.total_stocks_holding|floatformat:0|intcomma }} stocks ({{ config.total_stocks_holding|intcomma }} long + {{ config.total_stocks_holding|intcomma }} short)</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">Ranking Metric:</div>
                    <div>{{ config.ranking_metric|title }}</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">Sectors:</div>
                    <div>{% for sector in config.sectors %}{{ sector }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">Market Cap:</div>
                    <div>${{ config.min_market_cap|div:1000000000|floatformat:0|intcomma }}B - ${{ config.max_market_cap|div:1000000000|floatformat:0|intcomma }}B</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">Stock Price:</div>
                    <div>${{ config.min_stock_price|floatformat:0|intcomma }} - ${{ config.max_stock_price|floatformat:0|intcomma }}</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">Volume:</div>
                    <div>{{ config.min_volume|floatformat:0|intcomma }}M - {{ config.max_volume|floatformat:0|intcomma }}M shares</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backtest Progress -->
    <div class="card mb-4">
        <div class="card-header">
            <h3><i class="fas fa-chart-line"></i> Backtest Progress</h3>
        </div>
        <div class="card-body">
            <div id="progressContainer">
                <div class="text-center mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2">Initializing backtest...</p>
                </div>
                
                <div class="progress mb-3" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="progressBar">0%</div>
                </div>
                
                <div id="statusMessages" class="alert alert-info">
                    <strong>Status:</strong> <span id="statusText">Preparing data...</span>
                </div>
                
                <div id="errorMessages" class="alert alert-danger" style="display: none;">
                    <strong>Error:</strong> <span id="errorText"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy Details -->
    <div class="card mb-4">
        <div class="card-header">
            <h3><i class="fas fa-info-circle"></i> Strategy Execution Details</h3>
        </div>
        <div class="card-body">
            <div class="strategy-details">
                <h5>Monthly Rebalancing Process</h5>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">1. Filter:</div>
                    <div>Apply your filtering criteria to select eligible stocks</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">2. Calculate:</div>
                    <div>Compute {{ config.ranking_metric|title }} for all eligible stocks</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">3. Rank:</div>
                    <div>Sort stocks by the selected metric (highest to lowest)</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">4. Select:</div>
                    <div>
                        <div style="margin-left: 20px;">• Go long on top {{ config.total_stocks_holding|intcomma }} stocks</div>
                        <div style="margin-left: 20px;">• Go short on bottom {{ config.total_stocks_holding|intcomma }} stocks</div>
                    </div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">5. Weighting:</div>
                    <div>Allocate equal capital to each position</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 150px; font-weight: bold;">6. Rebalance:</div>
                    <div>Repeat process on first trading day of each month</div>
                </div>
                
                <h5 style="margin-top: 20px;">Performance Metrics</h5>
                <p>The backtest will calculate and compare the following metrics:</p>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 300px;">• Total Return and Annualized Return</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 300px;">• Sharpe Ratio and Sortino Ratio</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 300px;">• Maximum Drawdown</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 300px;">• Volatility and Beta</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 300px;">• Win Rate and Average Trade Return</div>
                </div>
                <div style="display: flex; margin-bottom: 8px;">
                    <div style="width: 300px;">• Performance vs S&P 500 Benchmark</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div style="margin-bottom: 2rem;">
        <button type="button" class="btn btn-primary btn-lg" id="startBacktestBtn">
            <i class="fas fa-play"></i> Start Backtest
        </button>
        <button type="button" class="btn btn-warning btn-lg" id="pauseBacktestBtn" style="display: none;">
            <i class="fas fa-pause"></i> Pause
        </button>
        <button type="button" class="btn btn-danger btn-lg" id="cancelBacktestBtn" style="display: none;">
            <i class="fas fa-stop"></i> Cancel
        </button>
        <a href="{% url 'strategies:equity_long_short_backtest_config' %}" class="btn btn-secondary btn-lg ms-3">
            <i class="fas fa-arrow-left"></i> Modify Configuration
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    let backtestInterval;
    let isPaused = false;
    
    function updateProgress(percentage, status) {
        $('#progressBar').css('width', percentage + '%').text(percentage + '%');
        $('#statusText').text(status);
        $('.progress').show();
    }
    
    function showError(message) {
        $('#errorText').text(message);
        $('#errorMessages').show();
        $('#statusMessages').hide();
        $('.spinner-border').hide();
        clearInterval(backtestInterval);
        $('#startBacktestBtn').show();
        $('#pauseBacktestBtn').hide();
        $('#cancelBacktestBtn').hide();
    }
    
    function startBacktest() {
        $('#startBacktestBtn').hide();
        $('#pauseBacktestBtn').show();
        $('#cancelBacktestBtn').show();
        $('.spinner-border').show();
        $('#statusMessages').show();
        $('#errorMessages').hide();
        
        // Simulate backtest progress
        let progress = 0;
        backtestInterval = setInterval(function() {
            if (!isPaused && progress < 100) {
                progress += Math.random() * 5;
                if (progress > 100) progress = 100;
                
                let status = '';
                if (progress < 20) {
                    status = 'Loading stock data...';
                } else if (progress < 40) {
                    status = 'Filtering universe based on criteria...';
                } else if (progress < 60) {
                    status = 'Calculating fundamental metrics...';
                } else if (progress < 80) {
                    status = 'Running monthly rebalancing simulations...';
                } else if (progress < 95) {
                    status = 'Calculating performance metrics...';
                } else {
                    status = 'Finalizing results...';
                }
                
                updateProgress(Math.round(progress), status);
                
                if (progress >= 100) {
                    clearInterval(backtestInterval);
                    $('.spinner-border').hide();
                    $('#pauseBacktestBtn').hide();
                    $('#cancelBacktestBtn').hide();
                    
                    // Redirect to results
                    setTimeout(function() {
                        window.location.href = '{% url "strategies:equity_long_short_run_backtest" %}';
                    }, 1000);
                }
            }
        }, 500);
        
        // Actually start the backtest via AJAX
        $.ajax({
            url: '{% url "strategies:equity_long_short_run_backtest" %}',
            method: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    // Store results and redirect
                    window.location.href = '{% url "strategies:equity_long_short_backtest_results" %}';
                } else {
                    showError(response.error || 'An error occurred during backtest');
                }
            },
            error: function(xhr, status, error) {
                showError('Network error: ' + error);
            }
        });
    }
    
    $('#startBacktestBtn').click(function() {
        startBacktest();
    });
    
    $('#pauseBacktestBtn').click(function() {
        isPaused = !isPaused;
        if (isPaused) {
            $(this).html('<i class="fas fa-play"></i> Resume');
            $('#statusText').text('Paused');
        } else {
            $(this).html('<i class="fas fa-pause"></i> Pause');
        }
    });
    
    $('#cancelBacktestBtn').click(function() {
        if (confirm('Are you sure you want to cancel the backtest?')) {
            clearInterval(backtestInterval);
            window.location.href = '{% url "strategies:equity_long_short_backtest_config" %}';
        }
    });
    
    // Auto-start backtest when page loads
    setTimeout(function() {
        startBacktest();
    }, 1000);
});
</script>
{% endblock %}
